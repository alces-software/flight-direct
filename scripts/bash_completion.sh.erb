_flight_complete() {
  local cmds cur

  COMPREPLY=()
  cmds="ls $cw_ROOT/libexec/actions"
  cur=${COMP_WORDS[COMP_CWORD]}

  if [[ $COMP_CWORD == 1 ]]; then
    COMPREPLY=($(compgen -W '<%= commands.keys.join(' ') %>' -- "$cur"))
  <% ['FL_ROOT', 'cw_ROOT'].map { |root| ENV[root] }
                           .map { |path| Dir.glob("#{path}/libexec/*") }
                           .flatten
                           .reject { |a| File.basename(a) == 'actions' }
                           .each do |cmd_dir|
  %>
  elif [[ '<%= File.basename(cmd_dir) %>' == "${COMP_WORDS[1]}" ]]; then
    <% init_subcmds = Dir.glob("#{cmd_dir}/actions/*").map do |cmd_path|
         File.basename(cmd_path)
       end.sort
    %>
    if [[ $COMP_CWORD == 2 ]]; then
      <% cmds = init_subcmds.reject { |c| c.include?('_') }
         init_subcmds.delete_if { |c| cmds.include?(c) }
      %>
      COMPREPLY=($(compgen -W '<%= cmds.join(' ') %>' -- "$cur"))
    fi
  <% end %>
  fi
}

complete -F _flight_complete flight fl
